<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Registro de Club</title>

  <!-- SIEMPRE primero -->
  <script src="config.js"></script>

  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body { font-family: Arial, sans-serif; max-width: 720px; margin: 20px auto; }
    h1 { margin-bottom: 16px; }
    #map { height: 300px; margin-top: 10px; }
    label { display: block; margin: 8px 0 4px; }
    input, select, button { margin-bottom: 10px; display: block; width: 100%; padding: 8px; box-sizing: border-box; }
    button[type="button"] { width: auto; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .muted { color: #666; font-size: 13px; }
  </style>
</head>
<body>
  <h1>Registro para Clubes</h1>

  <form id="form-registro-club">
    <label for="nombre">Nombre del club</label>
    <input type="text" id="nombre" placeholder="Nombre del club" required />

    <div class="row">
      <div>
        <label for="email">Correo electrónico</label>
        <input type="email" id="email" placeholder="ejemplo@club.com" required />
      </div>
      <div>
        <label for="telefono">Teléfono</label>
        <input type="tel" id="telefono" placeholder="5493511234567" />
      </div>
    </div>

    <label for="password">Contraseña</label>
    <input type="password" id="password" placeholder="Mínimo 6 caracteres" required />

    <label for="provincia">Provincia</label>
    <select id="provincia" required>
      <option value="">Seleccionar provincia</option>
    </select>

    <label for="localidad">Localidad</label>
    <select id="localidad" required disabled>
      <option value="">Seleccionar localidad</option>
    </select>

    <label for="direccion">Buscar dirección</label>
    <input type="text" id="direccion" placeholder="Calle y número, ciudad" />
    <button type="button" id="buscar">Buscar</button>
    <p class="muted">Tip: también podés hacer clic en el mapa para fijar la ubicación.</p>

    <div id="map"></div>

    <div class="row">
      <div>
        <label for="latitud">Latitud</label>
        <input type="number" id="latitud" placeholder="-31.420083" step="any" required readonly />
      </div>
      <div>
        <label for="longitud">Longitud</label>
        <input type="number" id="longitud" placeholder="-64.188776" step="any" required readonly />
      </div>
    </div>

    <label for="direccion-real">Dirección (opcional para mostrar en el perfil)</label>
    <input type="text" id="direccion-real" placeholder="Ej: Av. Siempre Viva 742" />

    <button type="submit">Registrarse</button>
  </form>

  <p>¿Ya tenés cuenta? <a href="login-club.html">Iniciar sesión</a></p>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    // --- Mapa Leaflet ---
    const map = L.map('map').setView([-34.6037, -58.3816], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    let marker = null;
    map.on('click', function(e) {
      const { lat, lng } = e.latlng;
      if (marker) {
        marker.setLatLng(e.latlng);
      } else {
        marker = L.marker(e.latlng).addTo(map);
      }
      document.getElementById('latitud').value = lat.toFixed(6);
      document.getElementById('longitud').value = lng.toFixed(6);
    });

    // --- Buscar dirección (Nominatim) ---
    document.getElementById('buscar').addEventListener('click', async () => {
      const direccion = (document.getElementById('direccion').value || '').trim();
      if (!direccion) {
        alert('Por favor ingresá una dirección.');
        return;
      }
      try {
        const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(direccion)}`;
        const resp = await fetch(url, { headers: { 'Accept-Language': 'es' } });
        const data = await resp.json();
        if (!Array.isArray(data) || data.length === 0) {
          alert('Dirección no encontrada.');
          return;
        }
        const { lat, lon } = data[0];
        const latNum = parseFloat(lat), lonNum = parseFloat(lon);
        map.setView([latNum, lonNum], 15);
        if (marker) marker.setLatLng([latNum, lonNum]); else marker = L.marker([latNum, lonNum]).addTo(map);
        document.getElementById('latitud').value = latNum.toFixed(6);
        document.getElementById('longitud').value = lonNum.toFixed(6);
      } catch (err) {
        console.error('Error al buscar dirección:', err);
        alert('Error al buscar la dirección.');
      }
    });

    // --- Provincias / Localidades desde tu backend ---
    async function cargarUbicaciones() {
      try {
        const res = await fetch(`${window.API_BASE_URL}/ubicaciones`);
        const data = await res.json();

        const selectProvincia = document.getElementById('provincia');
        const selectLocalidad = document.getElementById('localidad');

        selectProvincia.innerHTML = '<option value="">Seleccionar provincia</option>';
        selectLocalidad.innerHTML  = '<option value="">Seleccionar localidad</option>';
        selectLocalidad.disabled = true;

        Object.keys(data).forEach(prov => {
          const opt = document.createElement('option');
          opt.value = prov;
          opt.textContent = prov;
          selectProvincia.appendChild(opt);
        });

        selectProvincia.addEventListener('change', () => {
          const provincia = selectProvincia.value;
          selectLocalidad.innerHTML = '<option value="">Seleccionar localidad</option>';
          if (data[provincia]) {
            data[provincia].forEach(loc => {
              const opt = document.createElement('option');
              opt.value = loc;
              opt.textContent = loc;
              selectLocalidad.appendChild(opt);
            });
            selectLocalidad.disabled = false;
          } else {
            selectLocalidad.disabled = true;
          }
        });
      } catch (err) {
        console.error('Error cargando ubicaciones:', err);
        alert('No se pudieron cargar las provincias.');
      }
    }
    document.addEventListener('DOMContentLoaded', cargarUbicaciones);

    // --- Submit Registro de Club ---
    document.getElementById('form-registro-club').addEventListener('submit', async (e) => {
      e.preventDefault();

      const nombre    = (document.getElementById('nombre').value || '').trim();
      const email     = (document.getElementById('email').value || '').trim();
      const password  = (document.getElementById('password').value || '').trim();
      const telefono  = (document.getElementById('telefono').value || '').trim();
      const provincia = (document.getElementById('provincia').value || '').trim();
      const localidad = (document.getElementById('localidad').value || '').trim();
      const latStr    = (document.getElementById('latitud').value || '').trim();
      const lngStr    = (document.getElementById('longitud').value || '').trim();
      const direccion = (document.getElementById('direccion-real').value || '').trim();

      const latitud  = Number(latStr);
      const longitud = Number(lngStr);

      const faltan = [];
      if (!email) faltan.push('email');
      if (!password) faltan.push('password');
      if (!nombre) faltan.push('nombre');
      if (!provincia) faltan.push('provincia');
      if (!localidad) faltan.push('localidad');
      if (!Number.isFinite(latitud))  faltan.push('latitud (hacé click en el mapa o buscá dirección)');
      if (!Number.isFinite(longitud)) faltan.push('longitud (hacé click en el mapa o buscá dirección)');

      if (faltan.length) {
        alert('Faltan campos obligatorios: ' + faltan.join(', '));
        return;
      }

      try {
        const res = await fetch(`${window.API_BASE_URL}/registro-club`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            email,
            password,
            nombre,
            telefono,
            direccion,  // opcional: se guarda si viene
            latitud,
            longitud,
            provincia,
            localidad
          })
        });

        let data = {};
        try { data = await res.json(); } catch {}

        if (!res.ok) {
          console.error('Registro club error:', res.status, data);
          alert(data?.error || `Error al registrar club (HTTP ${res.status})`);
          return;
        }

        alert('Club registrado con éxito. Ahora podés iniciar sesión.');
        window.location.href = 'login-club.html';
      } catch (err) {
        console.error('❌ Error de red al registrar club:', err);
        alert('No se pudo conectar con el servidor.');
      }
    });
  </script>
</body>
</html>
