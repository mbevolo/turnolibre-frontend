<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Mis Datos - Club</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    #map { height: 300px; margin-bottom: 20px; }
    input, select { margin-bottom: 10px; }
  </style>
</head>
<body class="bg-light">
    <div class="mb-3">
  <a href="panel-club.html" class="btn btn-secondary">&larr; Volver al Panel</a>
</div>

  <div class="container my-4">
    <h2>Mis Datos del Club</h2>
    <form id="form-editar-club">
      <input type="text" id="nombreClub" class="form-control" placeholder="Nombre del club" required>
      <input type="email" id="emailClub" class="form-control" placeholder="Correo electrónico" disabled>
      <input type="tel" id="telefonoClub" class="form-control" placeholder="Teléfono" required>

      <label for="provinciaClub">Provincia:</label>
      <select id="provinciaClub" class="form-select" required>
        <option value="">Seleccionar provincia</option>
      </select>

      <label for="localidadClub">Localidad:</label>
      <select id="localidadClub" class="form-select" required disabled>
        <option value="">Seleccionar localidad</option>
      </select>

      <input type="text" id="direccionClub" class="form-control" placeholder="Dirección (opcional)">
      <input type="number" id="latitudClub" class="form-control" step="any" placeholder="Latitud" required>
      <input type="number" id="longitudClub" class="form-control" step="any" placeholder="Longitud" required>

      <button type="submit" class="btn btn-success">Guardar cambios</button>
    </form>

    <div id="alerta-edicion-club" class="alert alert-success d-none mt-2">✅ Datos actualizados correctamente.</div>

    <hr>
    <h5>Ubicación en el Mapa</h5>
    <button id="editar-ubicacion" class="btn btn-warning btn-sm mb-2">Editar ubicación en el mapa</button>
    <div id="map"></div>

    <hr>
    <h5>Configuración de MercadoPago</h5>
    <input id="input-access-token" type="text" class="form-control mb-2" placeholder="Access Token de MercadoPago">
    <button id="btn-guardar-access-token" class="btn btn-primary">Guardar Access Token</button>
    <a href="manual-access-token.html" target="_blank" class="d-block mt-1">¿Cómo obtener mi Access Token?</a>
    <div id="mensaje-access-token" class="mt-2"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <script>
    let clubEmail = localStorage.getItem('clubEmail');
    let clubData = null;
    let map, marker;

    async function cargarProvinciasYLocalidades() {
      const provinciaSelect = document.getElementById('provinciaClub');
      const localidadSelect = document.getElementById('localidadClub');
      localidadSelect.disabled = true;

      try {
        const res = await fetch('http://localhost:3000/ubicaciones');
        const data = await res.json();

        provinciaSelect.innerHTML = '<option value="">Seleccionar provincia</option>';
        Object.keys(data).forEach(prov => {
          const option = document.createElement('option');
          option.value = prov;
          option.textContent = prov;
          provinciaSelect.appendChild(option);
        });

        provinciaSelect.addEventListener('change', () => {
          const provinciaSeleccionada = provinciaSelect.value;
          localidadSelect.innerHTML = '<option value="">Seleccionar localidad</option>';
          localidadSelect.disabled = !provinciaSeleccionada;

          if (provinciaSeleccionada && data[provinciaSeleccionada]) {
            data[provinciaSeleccionada].forEach(localidad => {
              const option = document.createElement('option');
              option.value = localidad;
              option.textContent = localidad;
              localidadSelect.appendChild(option);
            });
            if (clubData?.localidad) {
              setTimeout(() => {
                localidadSelect.value = clubData.localidad;
              }, 300);
            }
          }
        });
      } catch (err) {
        console.error('Error al cargar provincias y localidades:', err);
      }
    }

    async function cargarDatosClub() {
      try {
        const res = await fetch(`http://localhost:3000/club/${clubEmail}`);
        clubData = await res.json();

        document.getElementById('nombreClub').value = clubData.nombre || '';
        document.getElementById('emailClub').value = clubData.email || '';
        document.getElementById('telefonoClub').value = clubData.telefono || '';
        document.getElementById('direccionClub').value = clubData.direccion || '';
        document.getElementById('latitudClub').value = clubData.latitud || '';
        document.getElementById('longitudClub').value = clubData.longitud || '';
        if (clubData.mercadoPagoAccessToken) {
          document.getElementById('input-access-token').value = clubData.mercadoPagoAccessToken;
        }

        await cargarProvinciasYLocalidades();
        if (clubData?.provincia) {
          document.getElementById('provinciaClub').value = clubData.provincia;
          document.getElementById('provinciaClub').dispatchEvent(new Event('change'));
        }

        if (clubData.latitud && clubData.longitud) {
          map.setView([clubData.latitud, clubData.longitud], 15);
          marker = L.marker([clubData.latitud, clubData.longitud]).addTo(map);
        }

      } catch (err) {
        alert('Error al cargar datos del club');
        console.error(err);
      }
    }

    document.addEventListener('DOMContentLoaded', async () => {
      map = L.map('map').setView([-34.6, -58.38], 12);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

      map.on('click', function(e) {
        const { lat, lng } = e.latlng;
        if (marker) {
          marker.setLatLng(e.latlng);
        } else {
          marker = L.marker(e.latlng).addTo(map);
        }
        document.getElementById('latitudClub').value = lat.toFixed(6);
        document.getElementById('longitudClub').value = lng.toFixed(6);
      });

      await cargarDatosClub();
    });

    document.getElementById('form-editar-club').addEventListener('submit', async (e) => {
      e.preventDefault();

      const body = {
        nombre: document.getElementById('nombreClub').value,
        telefono: document.getElementById('telefonoClub').value,
        direccion: document.getElementById('direccionClub').value,
        latitud: document.getElementById('latitudClub').value,
        longitud: document.getElementById('longitudClub').value,
        provincia: document.getElementById('provinciaClub').value,
        localidad: document.getElementById('localidadClub').value,
      };

      try {
        const res = await fetch(`http://localhost:3000/club/${clubData._id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });
        const data = await res.json();
        if (res.ok) {
          document.getElementById('alerta-edicion-club').classList.remove('d-none');
        } else {
          alert(data.error || 'Error al actualizar los datos');
        }
      } catch (err) {
        alert('Error al guardar datos');
      }
    });

    document.getElementById('btn-guardar-access-token').addEventListener('click', async () => {
      const token = document.getElementById('input-access-token').value.trim();
      if (!token) return alert('Debes ingresar el Access Token');

      const res = await fetch(`http://localhost:3000/club/${clubData._id}/access-token`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ accessToken: token })
      });

      const data = await res.json();
      document.getElementById('mensaje-access-token').textContent = data.mensaje || data.error;
    });
  </script>
</body>
</html>
